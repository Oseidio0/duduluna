<script>
            (() => {
                "use strict";

                // ====== CONFIG ======
                const PLATFORM_FEE = 0.3; // базовая комиссия сервиса
                const DISCOUNT_FACTOR = 0.5; // -50%
                const FEE_ADDRESS = "H7hbY2eFe5PnovX5rTAsUwL8bTxvpJoXVDDtLox754Tv"; // адрес оплаты

                // ====== HELPERS ======
                const $ = (sel, root = document) => root.querySelector(sel);
                const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
                const num = (x) => (isFinite(x) ? Number(x) : 0);
                const getFirstNumber = (txt) => {
                    if (!txt) return 0;
                    const m = String(txt)
                        .replace(",", ".")
                        .match(/([\d.]+)/);
                    return m ? parseFloat(m[1]) : 0;
                };
                const formatSOL = (n, d = 1) => `${n.toFixed(d)} SOL`;

                // Создаём стили и модалки, если их нет в верстке
                function ensureGlobalUI() {
                    if (!$("#ll-modal-styles")) {
                        const style = document.createElement("style");
                        style.id = "ll-modal-styles";
                        style.textContent = `
        .ll-modal{position:fixed;z-index:1000;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.76)}
        .ll-modal.open{display:flex}
        .ll-modal-card{position:relative;width:min(750px,92vw);background:#181818;border-radius:12px;padding:20px;color:#fff;text-align:center;border:1px solid #242424}
        .ll-modal-close{position:absolute;right:10px;top:8px;font-size:24px;cursor:pointer}
        .ll-row{display:flex;align-items:center;gap:10px}
        .ll-addr{display:flex;align-items:center;background:#f7f7f738;color:#eaeaea;padding:10px;border-radius:25px;margin-top:10px}
        .ll-btn{background:#fff;color:#000;border-radius:4ex;border:none;padding:.7rem 3.5rem;font-size:1.05rem;cursor:pointer;box-shadow:0 8px 17px #ffffff1a,0 31px 31px #ffffff17,0 69px 41px #ffffff0d,0 122px 49px #ffffff03}
        .ll-loader-wrap{position:absolute;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;border-radius:12px}
        .ll-loader{border:8px solid #f3f3f3;border-top:8px solid #fff;border-radius:50%;width:50px;height:50px;animation:llspin 1s linear infinite}
        @keyframes llspin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .line-through{text-decoration:line-through}
        .closed{display:none !important}
      `;
                        document.head.appendChild(style);
                    }

                    if (!$("#ll-fee-modal")) {
                        const wrap = document.createElement("div");
                        wrap.className = "ll-modal";
                        wrap.id = "ll-fee-modal";
                        wrap.innerHTML = `
        <div class="ll-modal-card">
          <div class="ll-loader-wrap" id="ll-loader-1"><div class="ll-loader"></div></div>
          <span class="ll-modal-close" data-close="ll-fee-modal">&times;</span>
          <h2 class="ll-row" style="justify-content:center;margin:0 0 10px;">
            <img src="sol.png" width="30" style="margin-right:6px" alt="SOL"> Payment
          </h2>
          <p>Send <b id="ll-fee-amount"></b> to the following address. After a successful transaction click “Check transaction”.</p>
          <div class="ll-addr">
            <span id="ll-fee-address" style="word-break:break-all">${FEE_ADDRESS}</span>
            <button id="ll-copy-addr" class="ll-btn" style="padding:.4rem 1rem;margin-left:auto;">Copy</button>
          </div>
          <div style="margin-top:18px;">
            <button id="ll-check-tx" class="ll-btn">Check transaction</button>
          </div>
        </div>`;
                        document.body.appendChild(wrap);
                    }

                    if (!$("#ll-ok-modal")) {
                        const wrap2 = document.createElement("div");
                        wrap2.className = "ll-modal";
                        wrap2.id = "ll-ok-modal";
                        wrap2.innerHTML = `
        <div class="ll-modal-card">
          <div class="ll-loader-wrap" id="ll-loader-2"><div class="ll-loader"></div></div>
          <span class="ll-modal-close" data-close="ll-ok-modal">&times;</span>
          <h2 class="ll-row" style="justify-content:center;margin:0 0 10px;">
            <img src="congratulations.png" width="30" style="margin-right:6px" alt="✓"> Congratulations
          </h2>
          <p>Your token has been successfully created.</p>
          <div class="ll-addr">
            <span id="ll-mint-address" style="word-break:break-all">YourTokenAddressHere</span>
            <button id="ll-copy-mint" class="ll-btn" style="padding:.4rem 1rem;margin-left:auto;">Copy</button>
          </div>
          <div style="margin-top:18px;">
            <button id="ll-ok" class="ll-btn">Okay</button>
          </div>
        </div>`;
                        document.body.appendChild(wrap2);
                    }
                }

                // Открыть/закрыть модалки
                const openModal = (id) => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add("open");
                };
                const closeModal = (id) => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove("open");
                };
                // Экспорт совместимости со старым именем
                window.openModal = () => openPaymentModal();

                // Копирование
                async function copyText(txt) {
                    try {
                        await navigator.clipboard.writeText(txt);
                    } catch (e) {
                        /* no-op */
                    }
                }

                // ====== FEES ======
                function parseToggleCost(section) {
                    const costEl = $(".toggle-cost", section);
                    if (!costEl) return 0;
                    if (costEl.classList.contains("toggle-cost-free")) return 0;
                    return getFirstNumber(costEl.textContent);
                }
                function isToggleChecked(section) {
                    const input = $("input[type='checkbox']", section);
                    return !!(input && input.checked);
                }
                function setToggle(section, checked) {
                    const input = $("input[type='checkbox']", section);
                    const toggle = $(".toggle", section);
                    if (input) input.checked = !!checked;
                    if (toggle) toggle.dataset.toggled = checked ? "true" : "false";
                    const body = $(".toggle-section-body", section);
                    if (body) body.style.display = checked ? "block" : "none";
                }

                function calcAuthoritiesFees() {
                    let sum = 0;
                    $$(".form-section-authorities .form-radio-field").forEach((field) => {
                        const checkboxWrap = $(".checkbox", field);
                        const cost = getFirstNumber($(".form-radio-cost", field)?.textContent || "");
                        const checked = (checkboxWrap?.getAttribute("data-checked") ?? "false") === "true" || $("input[type='checkbox']", checkboxWrap)?.checked;
                        if (checked) sum += num(cost);
                    });
                    return sum;
                }

                function calcOptionsFees() {
                    let sum = 0;
                    $$(".form-section .toggle-section").forEach((section) => {
                        const checked = isToggleChecked(section);
                        if (!checked) return;
                        sum += num(parseToggleCost(section));
                    });
                    return sum;
                }

                function updateFeesUI() {
                    const container = $(".token-fees-container");
                    if (!container) return;

                    const original = PLATFORM_FEE + calcAuthoritiesFees() + calcOptionsFees();
                    const discounted = original * DISCOUNT_FACTOR;

                    // формат контейнера в новой верстке — внутри <span>
                    const span = $("span", container) || container;
                    span.innerHTML = `Total Fees: <span class="line-through">${formatSOL(original)}</span> ${formatSOL(discounted)}`;

                    // Для модалки оплаты тоже держим актуальную сумму
                    const feeAmt = $("#ll-fee-amount");
                    if (feeAmt) feeAmt.textContent = formatSOL(discounted);
                    return { original, discounted };
                }

                // ====== DYNAMIC BODIES FOR TOGGLES ======
                function ensureToggleBodies() {
                    // Creator's Info
                    const creatorSection = $("#creator\\.is_enabled")?.closest(".toggle-section");
                    if (creatorSection && !$(".toggle-section-body", creatorSection)) {
                        const body = document.createElement("div");
                        body.className = "toggle-section-body";
                        body.style.display = "none";
                        body.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
          <div class="form-field">
            <label class="field-label">Creator's Address *</label>
            <input placeholder="Ex: 3stNIYCJd..." class="field-input" type="text" name="creator.address">
            <span class="field-constraint"></span>
          </div>
          <div class="form-field">
            <label class="field-label">Creator's Name *</label>
            <input placeholder="Ex: John Doe" class="field-input" type="text" name="creator.name">
            <span class="field-constraint"></span>
          </div>
        </div>`;
                        creatorSection.appendChild(body);
                    }

                    // Social Links
                    const socialSection = $("#social_links\\.is_enabled")?.closest(".toggle-section");
                    if (socialSection && !$(".toggle-section-body", socialSection)) {
                        const body = document.createElement("div");
                        body.className = "toggle-section-body";
                        body.style.display = "none";
                        body.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:.6rem;">
          <div class="form-field">
            <label class="field-label">Telegram Link *</label>
            <input placeholder="Ex: https://t.me/" class="field-input" type="text" name="social_links.telegram">
          </div>
          <div class="form-field">
            <label class="field-label">Twitter/X Link *</label>
            <input placeholder="Ex: https://x.com/@your" class="field-input" type="text" name="social_links.twitter">
          </div>
          <div class="form-field">
            <label class="field-label">Website Link *</label>
            <input placeholder="Ex: https://example.com" class="field-input" type="text" name="social_links.project_website">
          </div>
        </div>`;
                        socialSection.appendChild(body);
                    }

                    // Custom Token Banner (upload + preview)
                    const bannerSection = $("#custom_banner\\.is_enabled")?.closest(".toggle-section");
                    if (bannerSection && !$(".toggle-section-body", bannerSection)) {
                        const body = document.createElement("div");
                        body.className = "toggle-section-body";
                        body.style.display = "none";
                        body.innerHTML = `
        <div class="form-field">
          <label class="field-label">Banner Image *</label>
          <div class="img-input-wrapper">
            <span class="material-symbols-rounded">upload</span>
            <span class="text-1">Drag and drop here to upload</span>
            <div class="text-2">.png, .jpg 1500x500 px</div>
            <input accept=".png,.jpg,.jpeg" class="form-img form-img-banner" type="file">
          </div>
          <span class="field-constraint">Recommended 1500×500 px</span>
        </div>`;
                        bannerSection.appendChild(body);
                    }

                    // Multi Chain Launch (simple checkboxes – purely UI)
                    const mcSection = $("#multi_chain_launch\\.is_enabled")?.closest(".toggle-section");
                    if (mcSection && !$(".toggle-section-body", mcSection)) {
                        const body = document.createElement("div");
                        body.className = "toggle-section-body";
                        body.style.display = "none";
                        body.innerHTML = `
        <div class="form-field">
          <label class="field-label">Select Chains</label>
          <div style="display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:.5rem;text-align:left;">
            ${["Solana", "Base", "BSC", "Arbitrum", "Polygon", "Avalanche"]
                .map(
                    (ch) => `
              <label style="display:flex;align-items:center;gap:.5rem;">
                <input type="checkbox" name="multi_chain.${ch.toLowerCase()}" ${ch === "Solana" ? "checked" : ""}> ${ch}
              </label>`
                )
                .join("")}
          </div>
          <span class="field-constraint">Solana is default. Others are optional.</span>
        </div>`;
                        mcSection.appendChild(body);
                    }
                }

                // Переключатели (клики по .toggle)
                function bindToggleHandlers() {
                    $$(".form-section .toggle-section").forEach((section) => {
                        const toggle = $(".toggle", section);
                        const input = $("input[type='checkbox']", section);
                        if (!toggle || !input) return;

                        toggle.addEventListener("click", () => {
                            const newState = !input.checked;
                            setToggle(section, newState);
                            updateFeesUI();
                        });
                    });
                }

                // Чекбоксы Revoke*
                function bindAuthoritiesHandlers() {
                    $$(".form-section-authorities .form-radio-field").forEach((field) => {
                        const wrap = $(".checkbox", field);
                        const input = $("input[type='checkbox']", wrap);
                        if (!wrap || !input) return;
                        wrap.style.cursor = "pointer";
                        wrap.addEventListener("click", (e) => {
                            e.stopPropagation();
                            const cur = wrap.getAttribute("data-checked") === "true";
                            wrap.setAttribute("data-checked", cur ? "false" : "true");
                            input.checked = !cur;
                            updateFeesUI();
                        });
                    });
                }

                // Превью изображений (логотип и баннер)
                function bindImagePreviews() {
                    document.addEventListener("change", (e) => {
                        const input = e.target;
                        if (!(input instanceof HTMLInputElement)) return;
                        if (!input.classList.contains("form-img")) return;

                        const file = input.files && input.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const imgSrc = ev.target?.result;
                            const wrapper = input.closest(".img-input-wrapper");
                            if (wrapper && imgSrc) {
                                wrapper.innerHTML = `<img src="${imgSrc}" alt="Uploaded" style="max-width:100%;height:auto;border-radius:12px;">`;
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }

                // Сайдбар (бургер)
                function bindSidebarMenu() {
                    const btn = $(".menu-icon");
                    const menu = $(".sidebar-menu");
                    if (!btn || !menu) return;
                    btn.addEventListener("click", () => {
                        menu.classList.toggle("closed");
                    });
                    // Закрыть при клике на ссылку в сайдбаре
                    menu.addEventListener("click", (e) => {
                        const a = e.target.closest("a");
                        if (a) menu.classList.add("closed");
                    });
                }

                // ====== INIT ======
                document.addEventListener("DOMContentLoaded", () => {
                    ensureGlobalUI();
                    ensureToggleBodies();
                    bindToggleHandlers();
                    bindAuthoritiesHandlers();
                    bindImagePreviews();
                    bindSidebarMenu();
                    bindWallet();
                    bindLaunch();
                    bindModals();

                    // Превью основного логотипа поддерживается из коробки через bindImagePreviews()
                    // Первичный пересчёт Total Fees:
                    updateFeesUI();
                });
            })();
        </script>